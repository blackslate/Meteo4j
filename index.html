<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  <title>Meteo4j</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
<div class="sidebar">
<div class="logo">
<a href="/"><img src="img/logo.png" alt="Lexogram" /></a>
</div>
<nav>
<h2>Running the demo</h2>
<ul>
<li><a href="#top">Overview</a></li>
<li><a href="#graph-database">What's a graph database?</a></li>
<li><a href="#dependencies">Installing dependencies</a>
<ul>
<li><a href="#neo4j">Neo4j</a></li>
<li><a href="#nodejs">Node.js</a></li>
<li><a href="#meteor">Meteor</a></li>
<li><a href="#npm-package">Neo4j NPM Package</a></li>
<li><a href="#neo4jreactivity">Neo4j Reactivity</a></li>
</ul>
</li>
<li><a href="#meteo4j">Meteo4j</a></li>
</ul>
<h2>Building it yourself</h2>
<ul>
<li><a href="#create-node">Creating a node</a></li>
<li><a href="#subscribe">Publish and subscribe</a></li>
<li><a href="#template">Showing the nodes</a></li>
<li><a href="#on-the-fly">Adding nodes</a></li>
<li><a href="#relations">Links between nodes</a></li>
<li></li>
</ul>
</nav>
</div>

<main>
<header>
<h1><a href="https://github.com/lexogram/Meteo4j/">Meteo4j</a></h1>
</header>
<article>
<section id="top">
<p><a href="https://github.com/lexogram/Meteo4j/">Meteo4j</a> is a barebones demo of how to use a Neo4j <em>graph database</em> in a Meteor project. It allows you to create a maze from a series of rooms with one-way doors. Some doors to some rooms are locked. The keys can be found in other rooms.</p>
<figure>
<img src="img/map.png" width="200px" alt="A maze with 6 rooms and 3 locked doors" />
<figcaption>Figure 1. A maze with 6 rooms and 3 locked doors</figcaption>
</figure>
<p><a href="https://github.com/lexogram/Meteo4j/"><strong>Get the source files from GitHub</strong></a></p>
<p><a href="https://gist.github.com/jexp/43c6ee500e6fe97868df"><strong>A Neo4j model with Cypher queries by Michael Hunger</strong></a></p>
<p>This demo uses the <a href="https://github.com/VeliovGroup/ostrio-Neo4jreactivity">Neo4j Reactivity driver for Meteor</a> by <a href="https://github.com/dr-dimitru">Dmitriy Aristarkhovich</a>. You will also need to install Neo4j and its npm package, Node.js and Meteor.</p>
</section>
<section>
<h2><a id="graph-database" class="anchor" href="#graph-database" aria-hidden="true"><span class="octicon octicon-link"></span></a>What's a graph database?</h2>

<p id="dimitru01">A graph database uses nodes, edges and properties to represent and store data <a href="https://en.wikipedia.org/wiki/Graph_database">(Wikipedia)</a>. With a graph database, you can work directly on the relationships between your data objects.</p>

<p>A mental image: You know people. The people you know, know other people. People do things to things. You can think of each person and thing as a node, and each relationship or action as an edge. People have names, birthdays, interests and other 'properties'. In Neo4j, you create nodes like this: </p>

<pre>CREATE (jack:Person {name: "Jack"})
     , (jill:Person {name: "Jill"})
     , (house:House {name: "House"})
</pre>

<p>The relationships between people have properties too. These relationships are defined using ascii art:</p>

<pre>  (jill)-[:KNOWS {since: "childhood"}]-&gt;(jack)
, (jack)-[:BUILT]-&gt;(house)
</pre>

<p>You can define patterns of nodes and the way they are linked, and then ask the database for all the matches for this pattern:</p>

<pre>MATCH (a:Person)-[:KNOWS]-&gt;(b:Person)-[:BUILT]-&gt;(h:House)
RETURN a,b,h

a            b            h
name Jill    name Jack    name House
</pre>
</section>
<section>
<h2><a id="dependencies" class="anchor"><span class="octicon octicon-link"></span></a>Installing dependencies</h2>

<p>To run this demo, you will need:</p>

<ul>
<li>Neo4j</li>
<li>Node.js</li>
<li>Meteor</li>
<li>Neo4j NPM Package</li>
<li>The Meteo4j demo</li>
</ul>

<h3><a id="neo4j" class="anchor"><span class="octicon octicon-link"></span></a>Installing Neo4j</h3>

<p><a href="http://neo4j.com/download/">Download Neo4j community edition</a></p>

<p>Move it to User's root folder</p>

<pre>$ cd /path/to/your/download/folder
$ tar zxvf neo4j-community-2.2.4-unix.tar.gz <span class="comment"># unzip the file</span>
$ mv neo4j-community-2.2.4-unix ~/neo4j <span class="comment"># move it to the root of
your user folder</span>
</pre>

<p>Start Neo4j</p>

<pre class="revised"><span class="input">$ ~/neo4j/bin/neo4j start</span>
Starting Neo4j Server...WARNING: not changing user
process [6493]... waiting for server to be ready.............. OK.
http://localhost:7474/ is ready.
</pre>

<p>You can now try out Neo4j <a href="http://localhost:7474/">in your browser</a>.</p>

<ul>
<li><strong>Note: Neo4j database should be running before Meteor</strong></li>
</ul>

<h3><a id="nodejs" class="anchor" href="#nodejs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing Node.js</h3>

<p>Pick up the version for your system from the <a href="http://nodejs.org/download/">Node.js web site</a>. Follow the installer instructions.</p>

<h3><a id="meteor" class="anchor" href="#meteor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing Meteor</h3>

<h4><a id="linux-and-mac-os" class="anchor" href="#linux-and-mac-os" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linux and Mac OS</h4>

<p>Run this in Terminal:</p>

<pre>curl https://install.meteor.com/ | sh
</pre>

<h4><a id="windows" class="anchor"><span class="octicon octicon-link"></span></a>Windows</h4>

<p><a href="https://install.meteor.com/windows">Download the official Meteor installer here.</a></p>

<h3><a id="npm-package" class="anchor" href="#npm-package" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the Neo4j NPM Package</h3>

<pre class="revised"><span class="input">$ sudo npm -g install neo4j</span>
password:
</pre>

<p>If you prefer to develop in a non-admin account, you must switch to an account with admin privileges, so that you can install as the root user:</p>

<pre class="revised"><span class="input">$ su admin</span> # use your own admin account name
password:
<span class="input">$ sudo npm -g install neo4j</span>
password:
<span class="input">$ exit</span> # to return to your standard account
</pre>


<h3><a id="neo4jreactivity" class="anchor" href="#neo4jreactivity" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the Neo4j Reactivity Package</h3>

<p>Stop meteor if it is running. At the command line, type:</p>
<pre class="revised"><span class="input">$ meteor add ostrio:neo4jreactivity</span>

Changes to your project's package version selections:

coffeescript                 added, version 1.0.6
ostrio:minimongo-extensions  added, version 1.0.1
ostrio:neo4jdriver           added, version 0.2.15
ostrio:neo4jreactivity       added, version 0.9.0
sha                          added, version 1.0.3

ostrio:neo4jreactivity: Meteor.js Neo4j database reactivity layer</pre>

<h3><a id="meteo4j" class="anchor" href="#meteo4j" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the Meteo4j demo</h3>

<pre class="revised"><span class="input">$ cd /path/to/a/folder/
$ git clone https://github.com/lexogram/Meteo4j.git .</span>
Cloning into ....
remote: Counting objects: 18, done.
remote: Compressing objects: 100% (14/14), done.
remote: Total 18 (delta 1), reused 15 (delta 0), pack-reused 0
Unpacking objects: 100% (18/18), done.
<span class="input">$ cd app
$ meteor</span>

[[[[[ /Volumes/Mata/Learning/JavaScript/tests/Neo4j/test/app ]]]]]

=&gt; Started proxy.                             
=&gt; Started MongoDB.                           
=&gt; Started your app.                          

=&gt; App running at: http://localhost:3000/
</pre>

<p>When you have completed these steps, you should be able to see a demo of the application that you are going to build<a href="http://localhost:3000/">in your browser</a>.</p>
<p>In the browser console, you can now access <code>Meteor.neo4j</code> and see all its methods and properties.</p>
</section>
<section>
<h1><a id="" class="anchor" href="#" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building the demo yourself</h1>
<p>The demo that you have just seen gives you preview of what you can do with Neo4j and Meteor. Perhaps it's enough for you to study the code. Perhaps you'd prefer to start with a blank slate and bulid it yourself, learning about Meteor, Neo4j and the Cypher query language as you go.</p>
<div class="aside git">If you want to build this demo yourself from scratch, you can create a branch of your Git repository, and work on that.
<pre>git checkout -b startover</pre></div>
<p>Now delete the following files:</p>
<ul>
<code><li>meteo4j.html</li>
<li>meteo4j.css</li>
<li>meteo4j.js</li></code>
</ul>
<p>I'll show you, step by step, how to:</p>
<ul>
<li><a href="#create-node">Create a node and save it to the Neo4j database</a></li>
<li><a href="#subscribe">Control how the client can read and write to the database</a></li>



<li><a href=""></a></li>
<li><a href=""></a></li>
<li><a href=""></a></li>
<li><a href=""></a></li>
<li><a href=""></a></li>
<li><a href=""></a></li>



</ul>
<div class="aside note">This tutorial assumes that you can already:
<ul>
<li>Use the command line</li>
<li>Use your browser's Developer Tools, debugger and JavaScript console</li>
<li>Use a text editor like <a href="http://www.sublimetext.com/3">Sublime Text</a> to edit your code</li>
<li>Read and understand JavaScript</li>
</ul>
</div>
</section>
<section>
<h2><a id="create-node" class="anchor" href="#create-node" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hello World: creating a node</h2>
<p>There are three ways of interacting with Neo4j. Some provide you with <a href="https://meteorhacks.com/introduction-to-latency-compensation">latency compensation</a>. Others act immediately. The easiest way to begin is by using the Meteo.N4JDB object that is created automatically by the ostrio_Neo4jreactivity.js script, part of the Neo4j Reactivity module.</p>
<p id="dimitru02">The Meteor.N4JDB object is only available on the server. It gives a direct connection with the Neo4j database running on the server, where it writes all updates instantly. To test this, create the following script and save it as `meteo4j.js`:</p>
<pre>if (Meteor.isServer) {
  <span class="comment">// Check if there are any nodes with a Meteo4J label in the
  // database, using a standard cypher query</span>
  var label = "Meteo4j"
  var matchQuery = "MATCH (n:" + label + ") RETURN n"
  var options = null
  Meteor.N4JDB.query(matchQuery, options, matchCallback)

  function matchCallback(error, nodeArray) {
    console.log(error, nodeArray)
    if (error) {
      return console.log(error)
    } 

    <span class="comment">// There are no Meteo4j nodes, create one</span>
    if (!nodeArray.length) {
      var createQuery = "CREATE (n:"+ label +" {name: 'Start'})"
      Meteor.N4JDB.query(createQuery, options, createCallback)

      function createCallback(error, resultArray) { 
        if (error) {
          return console.error('New node not created:', error)
          <span class="comment">// { [Error: ...</span>
        }

        <span class="comment">//console.log(result) // []
        
        // The node is ready to use. See it at...
        // http://localhost:7474/browser/
        // ... using the query:
        // MATCH (n:Meteo4j) RETURN n</span>
       }
    }
  }
}</pre>
<div class="aside note">In Meteor, by default, all JavaScript code is run both on the server and in the browser. There are two techniques that you can use to make sure a section of your code only runs in one place:
<ul>
<li>You can wrap sections of your code in an <code>if (Meteor.isServer) { ... }</code> or an <code>if (Meteor.isClient) { ... }</code>, statement, as you have done here.</li>
<li>You can <a href="http://docs.meteor.com/#/full/structuringyourapp">create folders at the root of your project</a> called <code>client/</code> and <code>server/</code> and put specific files in each folder.</li>
</ul></div>
<p>If your Meteor app is not already running, you can start it like this:</p>
<pre>$ cd /path/to/Meteo4j/app/
$ meteor run</pre>
<div class="aside note" id="dimitru03">You currently don't have any HTML files to display in the browser, but Meteor will make one for you and fill it with 43 JavaScript files, taking up over 500 KB of bandwidth. This is quite normal: you are working in development mode, and each separate JavaScript file is sent exactly as it is so that everything is easy to debug.
<p>When you are ready to go live with your application, your can run <code>meteor -- production</code>. All unnecessary libraries will be excluded, all scripts will be minified and concatenated, and the result will be a single file. Depending on how much custom code you write, this may be as small as 107 KB.</p></div>
<p>Look in your command line window. You should see something like this:</p>
<pre class="revised"><span class="input">$ meteor run</span>
[[[[[ /Volumes/Mata/Meteo4j/app ]]]]]

=> Started proxy.                             
=> Started MongoDB.                           
I20150826-15:10:37.435(-4)? Meteor is successfully connected to
Neo4j on http://neo4j:1234@localhost:7474
=> Started your app.

=> App running at: http://localhost:3000/
I20150826-15:10:38.362(-4)? null []</pre>
<p>The last line is the output of the command <code>console.log(error, nodeArray)</code> in the <code>matchCallback</code> method. It tells you that there were no nodes with the label <code>Meteo4j</code> when you first started the app. Now check in the Neo4j browser to see if a node has been created there:</p>
<figure>
<img src="img/matchMeteo4j.png" alt="Using the Neo4j browser to check that your node has been created" />
<figcaption>Figure 2. Using the Neo4j browser to check that your node has been created</figcaption>
</figure>
</section>
<section>
<h2><a id="subscribe" class="anchor" href="#subscribe" aria-hidden="true"><span class="octicon octicon-link"></span></a>Publish and subscribe: sharing data with the browser</h2>
<p id="dimitru04">By default, Meteor opens up a security breach. The default <a href="https://atmospherejs.com/meteor/autopublish">autopublish package</a> gives the browser access to all data in the database, and the <a href="https://atmospherejs.com/meteor/insecure">insecure package</a> allows anyone who knows how to use the console in their browser to take control of the contents of your database. This is very helpful while you are developing your app, as it allows you, the developer, to do exactly what you want.</p>
<p>When you install the Neo4jReactivity package, a JavaScript file is installed at <code>.meteor/local/build/programs/server/packages/ostrio_neo4jreactivity.js</code>  that explicitly uses the <code>publish</code> command (which you will see in a moment). Meteor notices this, and prints a warning in your command line window, recommending that you remove the autopublish module.</p>
<figure>
<img src="img/autopublish.png" alt="A warning to remove autopublish" />
<figcaption>Figure 3. The Neo4jReactivity package is incompatible with autopublish.</figcaption>
</figure>
<p>Before you put your app online, you will want to deal with this. Here's how: at the command line, type:</p>
<pre>$ meteor remove autopublish     
                                              
<span class="comment">Changes to your project's package version selections:
                                              
autopublish  removed from your project        

autopublish: removed dependency</span>           
$ meteor remove insecure
                                              
<span class="comment">Changes to your project's package version selections:
                                              
insecure  removed from your project           

insecure: removed dependency</span></pre>
<p>Now that you have broken the automatic link between the server and the client, you need to manually repair it... but just for the data that you want the client to share.</p>
<h3>Publishing just what's needed</h3>
<p>To give the browser access to specific data from the database requires three steps:</p>
<ul>
<li>Creating a named collection in both the server and the client (a.k.a. the browser)</li>
<li>On the server, creating a query to define the data to be <em>publish</em>ed to the client</li>
<li>In the browser, <em>subscrib</em>ing to the collection that was created by the server.</li>
</ul>

<div class="aside tip">Here is an edited version of the <a href="https://github.com/VeliovGroup/ostrio-Neo4jreactivity">official documentation</a> for this publish-subscribe feature.
<p><code>Meteor.neo4j.collection(name)</code></p>

<ul>
<li><code>name</code> {<em>String</em>} - Name of collection. </li>
</ul>

<pre>users = Meteor.neo4j.collection('Users')</pre>

<p>This method returns a collection with the following methods:</p>

<ul>
<li><code>publish(name, func, [onSubscribe])</code> [<strong>Server</strong>] - Publish dataset to client. 

<ul>
<li><code>name</code> {<em>String</em>} - Publish/Subscription name</li>
<li><code>func</code> {<em>Function</em>} - Function which returns Cypher query</li>
<li><code>onSubscribe</code> {<em>Function</em>} - Optional callback function called right after data is published</li>
</ul></li>
</ul>

<pre>users.publish('currentUser', function() {
  var userID = this._id // this = options sent from subscribe()
  return 'MATCH (user:User {_id: "'+userID+'"}) RETURN user';
})</pre>

<ul>
<li><code>subscribe(name, [options], link)</code> [<strong>Client</strong>] - Subscribe to dataset.

<ul>
<li><code>name</code> {<em>String</em>} - Publish/Subscription name</li>
<li><code>options</code> {<em>Object</em>|<em>null</em>} - A map of parameters for the Cypher query</li>
<li><code>link</code> {<em>String</em>} - Sub object name, to link as MobgoDB row(s).</li>
</ul></li>
</ul>

<pre>users.subscribe('currentUser', {_id: Meteor.uuid()}, 'user')</pre>
</ul></div>

<div class="aside note" id="dimitru05">The use of the term <span class="keyword">collection</span> reveals how the Neo4j driver depends on the <a href="https://www.meteor.com/mini-databases">minimongo database</a> that runs in the browser. However, this term </p>
<p>Meteor uses <a href="http://docs.mongodb.org/manual/">MongoDB</a> as its built-in database, and MongoDB uses <span class="keyword">collections</span> to assemble data documents with a particular structure. Each collection in a MongoDB database has a name.</p>
<p>The data set that Neo4j returns from a Cypher query is stored in the browser as a minimongo collection. If you need to work with the results of different Cypher queries, each will need to be stored in a separate collection.</p>
<p>The <code>subscribe</code> client-side method returns an object that connects to the results of a particular query, and updates these results every time they change on the server database. You can use the options parameter to customize the query that will be executed by the server when it receives the subscription request.</p>
<p>For a more complete description of the process, see <a href="http://stackoverflow.com/a/21853298/1927589">Dan Dascalescu's answer on StackOverflow</a>.</p></div>

<h3>Communicating with the client</h3>

<p>Below, you will see in <strong>bold</strong> the changes you can make to your <code>meteo4j.js</code> file. The first line creates a variable called <code>Nodes</code> which refers to the collection of data that is to be published.</p>
<p>Note that I have wrapped most of the code that you used in the first step in an <span class="keyword">immediately-invoked function expressio</span> (IIFE). This is just for tidiness. Most text editors will allow you to collapse a function to a single line, so that your code becomes easier to read. I've also changed the name of the first node from "hello world" to "Start", as this name will be more useful later.</p>

<pre class="revised"><span class="new">var Nodes = Meteor.neo4j.collection("Nodes")
var publishKey = "Meteo4jNodes"</span>

if (Meteor.isServer) {
   var label = "Meteo4j"
   var matchQuery = "MATCH (node:" + label + ") RETURN node"
 
  <span class="new">;(function createTheFirstNode(){</span>
    // Check if there are already any nodes with a Meteo4J label
    var options = null
    Meteor.N4JDB.query(matchQuery, options, matchCallback)

    function matchCallback(error, nodeArray) {
      console.log(error, nodeArray)
      if (error) {
        return console.log(error)
      } 

      // There are no nodes, create one
      if (!nodeArray.length) {
        var createQuery = "CREATE (n:"+label+" {name: '<span class="new">Start</span>'})"
        Meteor.N4JDB.query(createQuery, options, createCallback)

        function createCallback(error, resultArray) { 
          if (error) {
            return console.error('Node not created:', error)
          }
        }
      }
    }  
  <span class="new">})()

  Nodes.publish(publishKey, publishQuery)

  function publishQuery(){
    return matchQuery
  }</span>
}

<span class="new">if (Meteor.isClient) {
   Tracker.autorun(function trackDataChanges(){
    var options = null
    var link = "node" // object name, to link as MongoDB row(s).
    var subscription = Nodes.subscribe(publishKey, options, link)
    console.log("Nodes: ", Nodes)
    console.log("subscription: ", subscription)
  })
}</span></pre>

<p><code>Tracker</code> is a tiny module that watches for changes in data, and when it detects such a change, it calls the functions that it has been told are associated with that change. When the web page loads in the browser, Tracker calls the <code>trackDataChanges</code> function a first time, to connect the client in the browser to the data published by the server. Any time the data on the server changes (for example because another connected user made a change that was forwarded to the server), the <code>trackDataChanges</code> function will be called again and the values in the browser's copy of the data will be updated.</p>
<p class="aside info">For more information on the <code>Tracker.autorun( ... )</code> method, you can see the <a href="https://github.com/meteor/meteor/wiki/Tracker-Manual">GitHub documentation for the Tracker library</a>.</p>
<<p>No options are required in this particular case, but you could use the options object to tell the Neo4j database on the server to send you all the data for the current user's userID, for example.</p>

<p id="dimitru06">In your browser, if you open the Developer Tools and put a debug breakpoint on the line at the end that says <code>console.log("Nodes: ", Nodes)</code>, you will be able to see how the "Start" node is made available to the JavaScript that runs in the browser. You can also look at what the subscription object looks like, and how it stores its customized query.</p>
<figure>
<img src="img/logNodes.png" alt="Observing the Nodes variable in the browser console" />
<figcaption>Figure 4. Observing the Nodes variable and the subscription object that it returns</figcaption>
</figure>
<p>Note that the key and the <code>_id</code> of the node object ("cNHeJ7X9eTatJnucz" in this illustration) may be different every time the application is run, but the <code>metadata.id</code> of the node object will always be the same number.</p>
</section>
<section>
<h2><a id="template" class="anchor" href="#template" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using a Meteor template to show the Neo4j nodes</h2>
<p>So far, you have been looking at output in the Neo4j browser, in the command line window and in the JavaScript console to understand how Neo4j and Meteor are working together. Now you are ready to display data from the Neo4j database in a web page in the browser.</p>
<div class="aside tip">If you are familiar with Meteor's template system, this next section will be very straightforward. If you are new to Meteor, you might want to do some additional reading:
<ul>
<li><a href="http://meteor.github.io/blaze/docs.html">Blaze: Live HTML templates</a></li>
<li><a href="https://www.discovermeteor.com/blog/a-guide-to-meteor-templates-data-contexts/">Discover Meteor blog</a></li>
<li><a href="http://docs.meteor.com/#/full/templates_api">Meteor Documentation</a></li>
</ul>
</div>
<h3>Creating an HTML page with templates</h3>
<p>Create a new HTML document called `meteo4j.html` at the root of your Meteor app folder, and give it this content:</p>
<pre>&lt;body&gt;
  &lt;h1&gt;List of nodes&lt;/h1&gt;
  {{&gt; nodeList}}
&lt;/body&gt;

&lt;template name="nodeList"&gt;
  &lt;ul&gt;
    {{#each nodes}}
      {{&gt; node}}
    {{/each}}
  &lt;/ul&gt;
&lt;/template&gt;

&lt;template name="node"&gt;
  &lt;li&gt;{{name}}&lt;/li&gt;
&lt;/template&gt;</pre>
<p>If you are new to Meteor, here are some things to note:</p>
<ul>
<li>Meteor will automatically created a <code>&lt;head&gt;</code> element for you, so you don't need to include it, nor the opening and closing <code>&lt;html&gt;</code> tags.</li>
<li>In additon to the <code>&lt;body&gt;</code>, there are also two <code>&lt;template&gt;</code> elements. This is part of the Meteor magic.</li>
<li>The <code>&lt;body&gt;</code> element contains something that does not look like HTML: <code>{{>&nbsp;nodes}}</code>. The template elements also include these non-HTML curly brackets.</li>
</ul>
<h3>Blaze and live templates</h3>
<p>Meteor uses a <span class="keyword">live page update technology</span> called <a href="https://www.meteor.com/blaze">Blaze</a>, and Blaze uses a <span class="keyword"> templating language</span> called <a href="https://github.com/meteor/meteor/blob/devel/packages/spacebars/README.md">Spacebars</a>. If you have worked with <a href="http://handlebarsjs.com/">Handlebars</a> or <a href="https://github.com/janl/mustache.js/blob/master/README.md">Mustache</a> templates, then this will be something that you are already comfortable with. If not, then you are in for a treat.</p>
<p>When Meteor renders the page, the Spacebars <code>{{ ... }}</code> blocks will be filled with data that is defined in a JavaScript file. Here's how you can update the client-side part of your <code>meteo4j.js</code> file so that it fills in the blanks:</p>
<pre class="revised">...

if (Meteor.isClient) {
  Tracker.autorun(function autorun(){
    var options = null // becomes `this` in the publishQuery() method
    var link = "node" // object name, to link as MongoDB row(s).
    var subscription = Nodes.subscribe(publishKey, options, link)
    // console.log("Nodes: ", Nodes)
    // console.log("subscription: ", subscription)
  })

  <span class="new">Template.nodeList.helpers({
    nodes: function nodes() {
      var cursor = Nodes.find()
      console.log("nodes: ", cursor.fetch())
      return cursor
    }
  })</span>
}</pre>
<h3>Inserting a template into the HTML page</h3>
<p>Note that the HTML page contains three different kinds of Spacebars blocks:</p>
<h4>Template placements</h4>
<pre class="revised"><span class="new">{{> </span><em>templateName</em><span class="new">}}</span></pre>
<h4>Operations</h4>
<pre class="revised"><span class="new">{{#</span><em>operator valueName</em><span class="new">}}</span>
  <em>// more stuff</em>
<span class="new">{{/</span><em>operator</em><span class="new">}}</span></pre>
<h4>Data placements</h4>
<pre class="revised"><span class="new">{{</span><em>valueName</em><span class="new">}}</span></pre>
<br />
<p>Each has its own particular role.</p>
<p>A <code class="revised"><span class="new">{{> </span><em>templateName</em><span class="new">}}</span></code> template placement block indicates where a template will be inserted. When the page is rendered, this...</p>
<pre>&lt;body&gt;
  &lt;h1&gt;List of nodes&lt;/h1&gt;
  {{&gt; nodeList}}
&lt;/body&gt;</pre>
<p>... will be replaced by the contents of the <code>nodes</code> template, to become this:</p>
<pre class="revised">&lt;body&gt;
  &lt;h1&gt;List of nodes&lt;/h1&gt;
  <span class="new">&lt;ul&gt;
    {{#each nodes}}
      {{&gt; node}}
    {{/each}}
  &lt;/ul&gt;</span>
&lt;/body&gt;</pre>
<p>If <code>nodes</code> refers to a list of four items, then the <code class="revised"><span class="new">{{#each </span><em>node</em><span class="new">}}</span></code> structure will be replaced by four list items:</p>
<pre class="revised">&lt;body&gt;
  &lt;h1&gt;List of nodes&lt;/h1&gt;
  &lt;ul&gt;
    <span class="new">&lt;li&gt;</span><em>{{name}}</em><span class="new">&lt;/li&gt;
    &lt;li&gt;</span><em>{{name}}</em><span class="new">&lt;/li&gt;
    &lt;li&gt;</span><em>{{name}}</em><span class="new">&lt;/li&gt;
    &lt;li&gt;</span><em>{{name}}</em><span class="new">&lt;/li&gt;</span>
  &lt;/ul&gt;
&lt;/body&gt;</pre>
<p>The actual contents of each list item will be decided by the <code>name</code> property of the different objects stored in the <code>nodes</code> list.</p>
<h3>Data from a JavaScript template</h3>
<p>When a <code>&lt;template name="<em class="comment">templateName</em>"&gt;</code> element is defined in an HTML file, Meteor will automatically add an object with the same name to the Meteor Template global. In other words, the presence of <code>&lt;template name="nodeList"&gt;</code> in an HTML file leads to the existence of a JavaScript object at <code>Template.nodeList</code>. This object will have a number of <a href="http://docs.meteor.com/#/full/templates_api">properties and methods</a>, including a <code>helpers</code> method. You can call this method and send it an object with the structure <code>{ <em>key</em>: <em>function</em>, ...}</code>, just like this:</p>
<pre>Template.nodeList.helpers({
  nodes: function nodes() {
    var cursor = Nodes.find()
    return cursor
  }
})</pre>
<p>Whenever you find <code>{{ nodes}}</code> inside a template called <code>nodeList</code>, the block will be replaced by the result of the call to the <code>nodes</code> function that is defined as one of the <code>nodeList.helpers</code>. In other words, <code>{{#each nodes}}</code> will refer, one by one, to each item returned by a cursor on the Nodes collection that was published by the server as the result of the Cypher call <code>"MATCH (n:Meteo4j) RETURN n"</code> .</p>
<h3>Mongo cursors</h3>
<p>So what, exactly, is a cursor in this context? You can discover this by looking at the print-out in the browser console, after the <code>nodes</code> helper has been called.</p>
<figure>
<img src="img/nodesCursor.png" alt="Observing the value of Nodes.find()" />
<figcaption>Figure 5. Observing the value of <code>Nodes.find()</code></figcaption>
</figure>
<p>The <code>Nodes</code> object is a Mongo collection, and it can respond to <a href="http://docs.mongodb.org/manual/reference/method/js-collection/">all the Mongo methods</a> such as <code>find()</code>. Calling the <code>find()</code> method returns a <a href="http://docs.mongodb.org/manual/core/cursors/"><span class="keyword">cursor</span></a>. This is an object that can step through all the results of the database query, one by one. The <code>{{#each nodes}}</code> operation in the HTML template is what makes it move to the next result and display it.</p>
<p>You may notice that the <code>nodes</code> helper function is called twice. The first time, the query returned no nodes. If you put a debug breakpoint inside the <code>nodes</code> function, you will see that the first call came immediately after Tracker.autorun set up the subscription, and before the server had had time to tell the browser about the data that it contains.</p>
<p>The second time that the <code>nodes</code> helper function was called was when the web page wase rendering and the <code>nodeList</code> template needed to find the values it has to display. The second time, connection between the physical database on the server and the <code>Nodes</code> collection in the browser has been made, and information about the node that you created in the first section is now available.</p>
<h3>Displaying metadata</h3>
<p>For now, you only have one node to display, and its name is "Start". You also gave it a label of "Meteo4j". The <code>name</code> is a direct property of the node object itself, so the HTML template can access it through the Spacebars block <code>{{name}}</code>.</p>
<p>However, the node's <code>id</code> and <code>labels</code> are stored in its <code>metadata</code> property. To be able to display these values, you will need to create a second helper function.</p>
<pre class="revised">...
if (Meteor.isClient) {
  Tracker.autorun(function trackDataChanges(){
    var options = null // becomes `this` in the publishQuery() method
    var link = "node" // object name, to link as MongoDB row(s).
    var subscription = Nodes.subscribe(publishKey, options, link)
    console.log("Nodes: ", Nodes)
    console.log("subscription: ", subscription)
  })

  Template.nodeList.helpers({
    nodes: function nodes() {
      var cursor = Nodes.find()
      console.log("nodes: ", cursor.fetch())
      return cursor
    }
  })

  <span class="new">Template.node.helpers({
    label: function label() {
      return this.metadata.labels[0]</span> // assumes labels exists
    <span class="new">}
  })</span>
}</pre>
<p>Now you can add a new Spacebars block to the <code>node</code> template in your <code>meteo4j.html</code> file:</p>
<pre class="revised">&lt;body&gt;
  &lt;h1&gt;List of nodes&lt;/h1&gt;
  {{&gt; nodeList}}
&lt;/body&gt;

&lt;template name="nodeList"&gt;
  &lt;ul&gt;
    {{#each nodes}}
      {{&gt; node}}
    {{/each}}
  &lt;/ul&gt;
&lt;/template&gt;

&lt;template name="node"&gt;
  &lt;li&gt;<span class="new">{{label}}: </span>{{name}}&lt;/li&gt;
&lt;/template&gt;</pre>
<p class="aside note">In the context of the Template function, the keyword <code>this</code> refers to the current element that is being treated.</p>
<p>If all went well, your web page should now look like this:</p>
<figure>
<img src="img/listOfNodes.png" alt="Displaying your first node in the browser" />
<figcaption>Figure 6. Displaying your first node in the browser</figcaption>
</figure>
<div class="aside tip">If you are new to Meteor, check that you can follow the patterns that match these items together:
<ul>
 <li>The <code class="revised"><span class="new">{{>&nbsp;</span><em>templateName</em><span class="new">}}</span></code> blocks</li>
 <li>The <code>&lt;template name="<em>templateName</em>" &gt;</code> elements in the HTML files</li>
 <li>The <code>Template.<em>templateName</em>.helpers( ... )</code> functions in the JavaScript files</li> 
 </ul>
 <p>Check also the matches between the terms inside Spacebars blocks in the HTML and the names of the <code>helper</code> functions in the JavaScript.</p></div>
<p class="aside disrupt">To see if you have understood, make a small modification to both the HTML file and the JavaScript file, so that it shows the <code>id</code> of the "Start" node, rather than its label.</p>
</section>
<section>
<h2><a id="on-the-fly" class="anchor" href="#on-the-fly" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adding nodes on-the-fly in the browser</h2>
<p>The aim of this tutorial is to create a maze of rooms with doors. Some doors are locked and some rooms contain keys. In this section, I'll show you how to create a form to allow you to:</p>
<ul>
<li>Create a new room</li>
<li>Create a door between two rooms</li>
<li>Lock a door</li>
<li>Hide a key for a given door in a given room</li>
</ul>
<p>I won't make any attempt yet to arrange the rooms in 2D space, because that will require a bunch of code that is not directly related to Neo4j. For now, it will be enough to create lists of rooms, doors and keys.</p>
</section>
<section>
<h2><a id="relations" class="anchor" href="#relations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating links between nodes</h2>
<p>You've seen how to create a node with a property and a label, and how to display it in the browser. But the real power of Neo4j is its ability to create relationships between nodes and to describe those relationships, and to search for nodes and relationship that match a particular pattern.</p>
<p>In this next step, I'll show you how to create a button that will  </p>
</section>
</article>
</body>
</html>
