<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  <title>Meteo4j</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
<div class="sidebar">
<div class="logo">
<a href="/"><img src="img/logo.png" alt="Lexogram" /></a>
</div>
<nav>
<h2>Running the demo</h2>
<ul>
<li><a href="#top">Overview</a></li>
<li><a href="#graph-database">What's a graph database?</a></li>
<li><a href="#dependencies">Installing dependencies</a>
<ul>
<li><a href="#neo4j">Neo4j</a></li>
<li><a href="#nodejs">Node.js</a></li>
<li><a href="#meteor">Meteor</a></li>
<li><a href="#npm-package">Neo4j NPM Package</a></li>
<li><a href="#neo4jreactivity">Neo4j Reactivity</a></li>
</ul>
</li>
<li><a href="#meteo4j">Meteo4j</a></li>
</ul>
<h2>Building it yourself</h2>
<ul>
<li><a href="#create-node">Creating a node</a></li>
<li><a href="#subscribe">Publish and subscribe</a></li>
<li><a href="#template">Showing the nodes</a></li>
<li></li>
</ul>
</nav>
</div>

<main>
<header>
<h1><a href="https://github.com/lexogram/Meteo4j/">Meteo4j</a></h1>
</header>
<article>
<section id="top">
<p><a href="https://github.com/lexogram/Meteo4j/">Meteo4j</a> is a barebones demo of how to use a Neo4j <em>graph database</em> in a Meteor project. It allows you to create a maze from a series of rooms with one-way doors. Some doors to some rooms are locked. The keys can be found in other rooms.</p>
<figure>
<img src="img/map.png" width="200px" alt="A maze with 6 rooms and 3 locked doors" />
<figcaption>Figure 1. A maze with 6 rooms and 3 locked doors</figcaption>
</figure>
<p><a href="https://github.com/lexogram/Meteo4j/"><strong>Get the source files from GitHub</strong></a></p>
<p>This demo uses the <a href="https://github.com/VeliovGroup/ostrio-Neo4jreactivity">Neo4j Reactivity driver for Meteor</a> by <a href="https://github.com/dr-dimitru">Dmitriy Aristarkhovich</a>. You will also need to install Neo4j and its npm package, Node.js and Meteor.</p>
</section>
<section>
<h2><a id="graph-database" class="anchor" href="#graph-database" aria-hidden="true"><span class="octicon octicon-link"></span></a>What's a graph database?</h2>

<p id="dimitru01">A graph database uses nodes, edges and properties to represent and store data <a href="https://en.wikipedia.org/wiki/Graph_database">(Wikipedia)</a>. With a graph database, you can work directly on the relationships between your data objects.</p>

<p>A mental image: You know people. The people you know, know other people. People do things to things. You can think of each person and thing as a node, and each relationship or action as an edge. People have names, birthdays, interests and other 'properties'. In Neo4j, you create nodes like this: </p>

<pre>CREATE (jack:Person {name: "Jack"})
     , (jill:Person {name: "Jill"})
     , (house:House {name: "House"})
</pre>

<p>The relationships between people have properties too. These relationships are defined using ascii art:</p>

<pre>  (jill)-[:KNOWS {since: "childhood"}]-&gt;(jack)
, (jack)-[:BUILT]-&gt;(house)
</pre>

<p>You can define patterns of nodes and the way they are linked, and then ask the database for all the matches for this pattern:</p>

<pre>MATCH (a:Person)-[:KNOWS]-&gt;(b:Person)-[:BUILT]-&gt;(h:House)
RETURN a,b,h

a            b            h
name Jill    name Jack    name House
</pre>
</section>
<section>
<h2><a id="dependencies" class="anchor"><span class="octicon octicon-link"></span></a>Installing dependencies</h2>

<p>To run this demo, you will need:</p>

<ul>
<li>Neo4j</li>
<li>Node.js</li>
<li>Meteor</li>
<li>Neo4j NPM Package</li>
<li>The Meteo4j demo</li>
</ul>

<h3><a id="neo4j" class="anchor"><span class="octicon octicon-link"></span></a>Installing Neo4j</h3>

<p><a href="http://neo4j.com/download/">Download Neo4j community edition</a></p>

<p>Move it to User's root folder</p>

<pre>$ cd /path/to/your/download/folder
$ tar zxvf neo4j-community-2.2.4-unix.tar.gz <span class="comment"># unzip the file</span>
$ mv neo4j-community-2.2.4-unix ~/neo4j <span class="comment"># move it to the root of
your user folder</span>
</pre>

<p>Start Neo4j</p>

<pre class="revised"><span class="input">$ ~/neo4j/bin/neo4j start</span>
Starting Neo4j Server...WARNING: not changing user
process [6493]... waiting for server to be ready.............. OK.
http://localhost:7474/ is ready.
</pre>

<p>You can now try out Neo4j <a href="http://localhost:7474/">in your browser</a>.</p>

<ul>
<li><strong>Note: Neo4j database should be running before Meteor</strong></li>
</ul>

<h3><a id="nodejs" class="anchor" href="#nodejs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing Node.js</h3>

<p>Pick up the version for your system from the <a href="http://nodejs.org/download/">Node.js web site</a>. Follow the installer instructions.</p>

<h3><a id="meteor" class="anchor" href="#meteor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing Meteor</h3>

<h4><a id="linux-and-mac-os" class="anchor" href="#linux-and-mac-os" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linux and Mac OS</h4>

<p>Run this in Terminal:</p>

<pre>curl https://install.meteor.com/ | sh
</pre>

<h4><a id="windows" class="anchor"><span class="octicon octicon-link"></span></a>Windows</h4>

<p><a href="https://install.meteor.com/windows">Download the official Meteor installer here.</a></p>

<h3><a id="npm-package" class="anchor" href="#npm-package" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the Neo4j NPM Package</h3>

<pre class="revised"><span class="input">$ sudo npm -g install neo4j</span>
password:
</pre>

<p>If you prefer to develop in a non-admin account, you must switch to an account with admin privileges, so that you can install as the root user:</p>

<pre class="revised"><span class="input">$ su admin</span> # use your own admin account name
password:
<span class="input">$ sudo npm -g install neo4j</span>
password:
<span class="input">$ exit</span> # to return to your standard account
</pre>


<h3><a id="neo4jreactivity" class="anchor" href="#neo4jreactivity" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the Neo4j Reactivity Package</h3>

<p>Stop meteor if it is running. At the command line, type:</p>
<pre class="revised"><span class="input">$ meteor add ostrio:neo4jreactivity</span>

Changes to your project's package version selections:

coffeescript                 added, version 1.0.6
ostrio:minimongo-extensions  added, version 1.0.1
ostrio:neo4jdriver           added, version 0.2.15
ostrio:neo4jreactivity       added, version 0.9.0
sha                          added, version 1.0.3

ostrio:neo4jreactivity: Meteor.js Neo4j database reactivity layer</pre>

<h3><a id="meteo4j" class="anchor" href="#meteo4j" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the Meteo4j demo</h3>

<pre class="revised"><span class="input">$ cd /path/to/a/folder/
$ git clone https://github.com/lexogram/Meteo4j.git .</span>
Cloning into ....
remote: Counting objects: 18, done.
remote: Compressing objects: 100% (14/14), done.
remote: Total 18 (delta 1), reused 15 (delta 0), pack-reused 0
Unpacking objects: 100% (18/18), done.
<span class="input">$ cd app
$ meteor</span>

[[[[[ /Volumes/Mata/Learning/JavaScript/tests/Neo4j/test/app ]]]]]

=&gt; Started proxy.                             
=&gt; Started MongoDB.                           
=&gt; Started your app.                          

=&gt; App running at: http://localhost:3000/
</pre>

<p>When you have completed these steps, you should be able to see a demo of the application that you are going to build<a href="http://localhost:3000/">in your browser</a>.</p>
<p>In the browser console, you can now access <code>Meteor.neo4j</code> and see all its methods and properties.</p>
</section>
<section>
<h1><a id="" class="anchor" href="#" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building the demo yourself</h1>
<p>The demo that you have just seen gives you preview of what you can do with Neo4j and Meteor. Perhaps it's enough for you to study the code. Perhaps you'd prefer to start with a blank slate and bulid it yourself, learning about Meteor, Neo4j and the Cypher query language as you go.</p>
<div class="aside git">If you want to build this demo yourself from scratch, you can create a branch of your Git repository, and work on that.
<pre>git checkout -b startover</pre></div>
<p>Now delete the following files:</p>
<ul>
<code><li>meteo4j.html</li>
<li>meteo4j.css</li>
<li>meteo4j.js</li></code>
</ul>
<p>I'll show you, step by step, how to:</p>
<ul>
<li><a href="#create-node">Create a node and save it to the Neo4j database</a></li>
<li><a href="#subscribe">Control how the client can read and write to the database</a></li>



<li><a href=""></a></li>
<li><a href=""></a></li>
<li><a href=""></a></li>
<li><a href=""></a></li>
<li><a href=""></a></li>
<li><a href=""></a></li>



</ul>
<div class="aside note">This tutorial assumes that you can already:
<ul>
<li>Use the command line</li>
<li>Use your browser's Developer Tools, debugger and JavaScript console</li>
<li>Use a text editor like <a href="http://www.sublimetext.com/3">Sublime Text</a> to edit your code</li>
<li>Read and understand JavaScript</li>
</ul>
</div>
</section>
<section>
<h2><a id="create-node" class="anchor" href="#create-node" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hello World: creating a node</h2>
<p>There are three ways of interacting with Neo4j. Some provide you with <a href="https://meteorhacks.com/introduction-to-latency-compensation">latency compensation</a>. Others act immediately. The easiest way to begin is by using the Meteo.N4JDB object that is created automatically by the ostrio_Neo4jreactivity.js script, part of the Neo4j Reactivity module.</p>
<p id="dimitru02">The Meteor.N4JDB object is only available on the server. It gives a direct connection with the Neo4j database running on the server, where it writes all updates instantly. To test this, create the following script and save it as `meteo4j.js`:</p>
<pre>if (Meteor.isServer) {
  <span class="comment">// Check if there are any nodes with a Meteo4J label in the
  // database, using a standard cypher query</span>
  var label = "Meteo4j"
  var matchQuery = "MATCH (n:" + label + ") RETURN n"
  var options = null
  Meteor.N4JDB.query(matchQuery, options, matchCallback)

  function matchCallback(error, nodeArray) {
    console.log(error, nodeArray)
    if (error) {
      return console.log(error)
    } 

    <span class="comment">// There are no Meteo4j nodes, create one</span>
    if (!nodeArray.length) {
      var createQuery = "CREATE (n:"+ label +" {name: 'Start'})"
      Meteor.N4JDB.query(createQuery, options, createCallback)

      function createCallback(error, resultArray) { 
        if (error) {
          return console.error('New node not created:', error)
          <span class="comment">// { [Error: ...</span>
        }

        <span class="comment">//console.log(result) // []
        
        // The node is ready to use. See it at...
        // http://localhost:7474/browser/
        // ... using the query:
        // MATCH (n:Meteo4j) RETURN n</span>
       }
    }
  }
}</pre>
<div class="aside note">In Meteor, by default, all JavaScript code is run both on the server and in the browser. There are two techniques that you can use to make sure a section of your code only runs in one place:
<ul>
<li>You can wrap sections of your code in an <code>if (Meteor.isServer) { ... }</code> or an <code>if (Meteor.isClient) { ... }</code>, statement, as you have done here.</li>
<li>You can <a href="http://docs.meteor.com/#/full/structuringyourapp">create folders at the root of your project</a> called <code>client/</code> and <code>server/</code> and put specific files in each folder.</li>
</ul></div>
<p>If your Meteor app is not already running, you can start it like this:</p>
<pre>$ cd /path/to/Meteo4j/app/
$ meteor run</pre>
<div class="aside note" id="dimitru03">You currently don't have any HTML files to display in the browser, but Meteor will make one for you and fill it with 43 JavaScript files, taking up over 500 KB of bandwidth. This is quite normal: you are working in development mode, and each separate JavaScript file is sent exactly as it is.
<p>When you are ready to go live with your application, your can run <code>meteor -- production</code>. All unnecessary libraries will be excluded, all scripts will be minified and concatenated, and the result will be a single file. Depending on how much custom code you write, this may be as small as 107 KB</p></div>
<p>Look in your command line window. You should see something like this:</p>
<pre class="revised"><span class="input">$ meteor run</span>
[[[[[ /Volumes/Mata/Meteo4j/app ]]]]]

=> Started proxy.                             
=> Started MongoDB.                           
I20150826-15:10:37.435(-4)? Meteor is successfully connected to
Neo4j on http://neo4j:1234@localhost:7474
=> Started your app.

=> App running at: http://localhost:3000/
I20150826-15:10:38.362(-4)? null []</pre>
<p>The last line is the output of the command <code>console.log(error, nodeArray)</code> in the <code>matchCallback</code> method. It tells you that there were no nodes with the label <code>Meteo4j</code> when you first started the app. Now check in the Neo4j browser to see if a node has been created there:</p>
<figure>
<img src="img/matchMeteo4j.png" alt="Using the Neo4j browser to check that your node has been created" />
<figcaption>Figure 2. Using the Neo4j browser to check that your node has been created</figcaption>
</figure>
</section>
<section>
<h2><a id="subscribe" class="anchor" href="#subscribe" aria-hidden="true"><span class="octicon octicon-link"></span></a>Publish and subscribe: sharing data with the browser</h2>
<p id="dimitru04">By default, Meteor opens up a security breach. The default <a href="https://atmospherejs.com/meteor/autopublish">autopublish package</a> gives the browser access to all data in the database, and the <a href="https://atmospherejs.com/meteor/insecure">insecure package</a> allows anyone who knows how to use the console in their browser to take control of the contents of your database. This is very helpful while you are developing your app, as it allows you, the developer, to do exactly what you want.</p>
<p>When you install the Neo4jReactivity package, a JavaScript file is installed at <code>.meteor/local/build/programs/server/packages/ostrio_neo4jreactivity.js</code>  that explicitly uses the <code>publish</code> command (which you will see in a moment). Meteor notices this, and prints a warning in your command line window, recommending that you remove the autopublish module.</p>
<figure>
<img src="img/autopublish.png" alt="A warning to remove autopublish" />
<figcaption>Figure 3. The Neo4jReactivity package is incompatible with autopublish.</figcaption>
</figure>
<p>Before you put your app online, you will want to deal with this. Here's how: at the command line, type:</p>
<pre>$ meteor remove autopublish     
                                              
<span class="comment">Changes to your project's package version selections:
                                              
autopublish  removed from your project        

autopublish: removed dependency</span>           
$ meteor remove insecure
                                              
<span class="comment">Changes to your project's package version selections:
                                              
insecure  removed from your project           

insecure: removed dependency</span></pre>
<p>Now that you have broken the automatic link between the server and the client, you need to manually repair it... but just for the data that you want the client to share.</p>
<h3>Publishing just what's needed</h3>
<p>To give the browser access to specific data from the database requires three steps:</p>
<ul>
<li>Creating a named collection in both the server and the client (a.k.a. the browser)</li>
<li>On the server, creating a query to define the data to be <em>publish</em>ed to the client</li>
<li>In the browser, <em>subscrib</em>ing to the collection that was created by the server.</li>
</ul>

<div class="aside tip">Here is an edited version of the <a href="https://github.com/VeliovGroup/ostrio-Neo4jreactivity">official documentation</a> for this publish-subscribe feature.
<p><code>Meteor.neo4j.collection(name)</code></p>

<ul>
<li><code>name</code> {<em>String</em>} - Name of collection. </li>
</ul>

<pre>users = Meteor.neo4j.collection('Users')</pre>

<p>This method returns a collection with the following methods:</p>

<ul>
<li><code>publish(name, func, [onSubscribe])</code> [<strong>Server</strong>] - Publish dataset to client. 

<ul>
<li><code>name</code> {<em>String</em>} - Publish/Subscription name</li>
<li><code>func</code> {<em>Function</em>} - Function which returns Cypher query</li>
<li><code>onSubscribe</code> {<em>Function</em>} - Optional callback function called right after data is published</li>
</ul></li>
</ul>

<pre>users.publish('currentUser', function() {
  var userID = this._id // this = options sent from subscribe()
  return 'MATCH (user:User {_id: "'+userID+'"}) RETURN user';
})</pre>

<ul>
<li><code>subscribe(name, [options], link)</code> [<strong>Client</strong>] - Subscribe to dataset.

<ul>
<li><code>name</code> {<em>String</em>} - Publish/Subscription name</li>
<li><code>options</code> {<em>Object</em>|<em>null</em>} - A map of parameters for the Cypher query</li>
<li><code>link</code> {<em>String</em>} - Sub object name, to link as MobgoDB row(s).</li>
</ul></li>
</ul>

<pre>users.subscribe('currentUser', {_id: Meteor.uuid()}, 'user')</pre>
</ul></div>

<div class="aside note" id="dimitru05">The use of the term <span class="keyword">collection</span> reveals how the Neo4j driver depends on the <a href="https://www.meteor.com/mini-databases">minimongo database</a> that runs in the browser.</p>
<p>Meteor uses <a href="http://docs.mongodb.org/manual/">MongoDB</a> as its built-in database, and MongoDB uses <span class="keyword">collections</span> to assemble data documents with a particular structure. Each collection in a MongoDB database has a name.</p>
<p>The data set that Neo4j returns from a Cypher query is stored in the browser as a minimongo collection. If you need to work with the results of different Cypher queries, each will need to be stored in a separate collection.</p></div>

<h3>Communicating with the client</h3>

<p>Below, you will see in <strong>bold</strong> the changes you can make to your <code>meteo4j.js</code> file. The first line creates a variable called <code>Nodes</code> which refers to the collection of data that is to be published.</p>
<p>Note that I have wrapped most of the code that you used in the first step in an <span class="keyword">immediately-invoked function expressio</span> (IIFE). This is just for tidiness. Most text editors will allow you to collapse a function to a single line, so that your code becomes easier to read. I've also changed the name of the first node from "hello world" to "Start", as this name will be more useful later.</p>

<pre class="revised"><span class="new">var Nodes = Meteor.neo4j.collection("Nodes")
var publishKey = "Meteo4jNodes"</span>

if (Meteor.isServer) {
   var label = "Meteo4j"
   var matchQuery = "MATCH (node:" + label + ") RETURN node"
 
  <span class="new">;(function createTheFirstNode(){</span>
    // Check if there are already any nodes with a Meteo4J label
    var options = null
    Meteor.N4JDB.query(matchQuery, options, matchCallback)

    function matchCallback(error, nodeArray) {
      console.log(error, nodeArray)
      if (error) {
        return console.log(error)
      } 

      // There are no nodes, create one
      if (!nodeArray.length) {
        var createQuery = "CREATE (n:"+label+" {name: '<span class="new">Start</span>'})"
        Meteor.N4JDB.query(createQuery, options, createCallback)

        function createCallback(error, resultArray) { 
          if (error) {
            return console.error('Node not created:', error)
          }
        }
      }
    }  
  <span class="new">})()

  Nodes.publish(publishKey, publishQuery)

  function publishQuery(){
    return matchQuery
  }</span>
}

<span class="new">if (Meteor.isClient) {
   Tracker.autorun(function autorun(){
    var options = null
    var link = "node" // object name, to link as MongoDB row(s).
    Nodes.subscribe(publishKey, options, link)
    console.log(Nodes)
  })
}</span></pre>

<p class="aside info">For more information on the <code>Tracker.autorun( ... )</code> method, you can see the <a href="https://github.com/meteor/meteor/wiki/Tracker-Manual">GitHub documentation for the Tracker library</a>.</p>

<p id="dimitru06">In your browser, if you open the Developer Tools and put a debug breakpoint on the line at the end that says <code>console.log(Nodes)</code>, you will be able to see how the "Start" node is made available to the JavaScript that runs in the browser.</p>
<figure>
<img src="img/logNodes.png" alt="Observing the Nodes variable in the browser console" />
<figcaption>Figure 4. Observing the Nodes variable in the browser console</figcaption>
</figure>
<p>Note that the key and the <code>_id</code> of the node object ("tRQDqDDk6kE8LW2Ng" in this illustration) may be different every time the application is run, but the <code>metadata.id</code> of the node object will always be the same number.</p>
</section>
<section>
<h2><a id="template" class="anchor" href="#template" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using a Meteor template to show the Neo4j nodes</h2>
<p></p>
</section>
</article>
</body>
</html>
